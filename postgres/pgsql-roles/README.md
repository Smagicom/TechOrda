# pgsql-roles

Чтобы подключиться к базе данных PostgreSQL, вам необходимо иметь учетные данные для входа.
В частности, должен существовать пользователь базы данных, которому разрешено подключаться к конкретной базе данных.

Пользователи базы данных чем-то похожи на пользователей операционной системы: у них есть имя и пароль.
Подобно пользователям операционной системы, пользователи базы данных могут быть объединены в группы пользователей, чтобы облегчить массовое администрирование пользователей.

В SQL концепция учетной записи и группы пользователей объединены в концепцию роли.

Роль может быть учетной группой пользователя, группой учетных записей или даже обеими, в зависимости от того, как вы ее настроите;
однако для облегчения управления роль должна выражать одно и только одно понятие одновременно: то есть это должен быть либо один пользователь, либо одна группа, но не то и другое одновременно.

Роль представляет собой набор прав в базе данных и свойств подключения.

Важно понимать, что роль определяется на уровне кластера. Это означает, что одна и та же роль может иметь разные привилегии и свойства в зависимости от используемой базы данных (например, ей разрешено подключаться к одной базе данных, а к другой нет).

## Управление ролями

Ролями можно управлять с помощью трех основных операторов SQL:

- `CREATE ROLE`, чтобы создать новую роль,
- `ALTER ROLE`, чтобы изменить свойства роли (например, пароль для входа)
- `DROP ROLE`, чтобы удалить существующую роль.

Установка пароля для конкретной роли не означает, что эта роль сможет подключаться к кластеру:
чтобы разрешить вход в систему, роль также должна иметь параметр `LOGIN`.

Следующая команда создаст пользователя, который не сможет войти в систему:

```
template1=# CREATE ROLE aigerim WITH PASSWORD 'xxx';
```

Параметр по умолчанию — `NOLOGIN` (что предотвращает интерактивный вход в систему).
Поэтому, чтобы создать пользователей, не забудьте добавить параметр `LOGIN` при создании роли:

```
postgres=# CREATE ROLE aigerim WITH LOGIN PASSWORD 'xxx';
```

## Использование роли в качестве группы

Группа — это роль, которая содержит другие роли. Это так просто!

Обычно, когда вы хотите создать группу, все, что вам нужно сделать, это создать роль без опции `LOGIN`, а затем добавить пользователей одного за другим в группу-роль.

Чтобы создать пользователя в определенной группе, можно использовать опцию `IN ROLE`.
В качестве примера в следующем блоке кода вы можете увидеть создание группы `book_authors` и добавление участников группы `aigerim` и `murat`:

```
postgres=# CREATE ROLE book_authors WITH NOLOGIN;
CREATE ROLE
postgres=# CREATE ROLE aigerim WITH LOGIN PASSWORD 'xxx' IN ROLE book_authors;
CREATE ROLE
postgres=# CREATE ROLE murat WITH LOGIN PASSWORD 'xxx' IN ROLE book_authors;
CREATE ROLE
```

Также, если ранее была создана роль, допустим `murat`, то чтобы добавить его в существующую группу
следует использовать операцию `GRANT ROLE`, далее приведен пример:

```
postgres=# GRANT ROLE book_authors TO murat;
```

## Управление входящими соединениями на уровне роли

Когда новое подключение к кластеру устанавливается, PostgreSQL проверяет входящий запрос на уровне роли.
Тот факт, что у роли есть свойство `LOGIN`, недостаточен для открытия нового соединения с базой данных.
Это связано с тем, что PostgreSQL проверяет входящий запрос на соединение с таблицей брандмауэра, определенной в файле `pg_hba.conf`.

Если в таблице указано, что роль может открывать соединение с указанной базой данных, соединение разрешается (при условии, что оно имеет свойство `LOGIN`); в противном случае оно отклоняется.

Каждый раз, когда вы изменяете файл `pg_hba.conf`, вам нужно перезагрузить (англ. "reload") кластер.
Поэтому обычный рабочий процесс при работе с `pg_hba.conf` похож на следующий:

1. Редактировать файл `pg_hba.conf`.
2. Перезагрузить `postgres`- `sudo -iu postgres psql -U postgres -c "SELECT pg_reload_conf();"`

## Синтаксис pg_hba.conf

Файл pg_hba.conf содержит брандмауэр для входящих соединений.
Каждая строка в файле имеет следующуй формат:

```
<connection-type> <database> <role> <remote-machine> <auth-method>
```

<table>
<tr>
    <th>Параметр</th>
    <th>Описание</th>
</tr>
<tr>
    <td>connection-type</td>
    <td>
        Это тип соединения, поддерживаемый PostgreSQL,<br>
        которые может иметь след. значения:<br>
        <ul>
            <li>- local - соединение через системные сокеты</li>
            <li>- host - TCP/IP соединение</li>
            <li>- hostssl - зашифрованное TCP/IP соединение</li>
        </ul>
    </td>
</tr>
<tr>
    <td>database</td>
    <td>
        Это имя конкретной базы данных, на которую ссылается строка<br>
        или специальное ключевое слово `all`, что означает каждую доступную базу данных.
    </td>
</tr>
<tr>
    <td>role</td>
    <td>
        Это название роли, или специальное ключевое слово all, <br>
        что означает все доступные роли (и группы).
    </td>
</tr>
<tr>
    <td>remote-machine</td>
    <td>
        Это имя хоста, IP-адрес или подсеть, из которой ожидается подключение.<br>
        Специальное ключевое слово all соответствует любому удаленному компьютеру,<br>
        с которого установлено соединение.
    </td>
</tr>
<tr>
    <td>auth-method</td>
    <td>
        определяет, как должны проверяться учетные данные для входа. Основными методами являются:
        <ul>
            <li>- scram-sha-256,</li>
            <li>- md5,</li>
            <li>- reject- который всегда отказывает от соединения,</li>
            <li>- trust, чтобы всегда принимать соединение, независимо от предоставленных учетных данных.</li>
        </ul>
    </td>

</tr>
</table>

Чтобы лучше понять, как работает система, ниже приведен пример файла `pg_hba.conf`:

```
host    all         aigerim     e1r1                scram-sha-256
hostssl all         test        192.168.222.1/32    scram-sha-256
host    digikamdb   pgwatch2    192.168.222.4/32    trust
host    digikamdb   murat       e1r1                reject
```

1. Первая строка указывает, что пользователь `aigerim` может подключаться к любой базе данных в кластере (ключ.слово `all`) через соединение TCP/IP (ключ.слово `host`), исходящее с хоста с именем `e1r1`, но она должна предоставить логин и пароль для проверки через метод аутентификации SCRAM.
2. Во второй строке указано, что роль `test` может подключаться к любой базе данных через соединение с шифрованием SSL (ключ.слово `hostssl`), но только с сервер с IPv4-адресом 192.168.222.1; опять же, учетные данные должны пройти через метод аутентификации SCRAM.
3. В третьей строке указано, что доступ к базе данных `digikamdb` предоставляется только пользователю `pgwatch2` через незашифрованное соединение с хоста `192.168.222.4`; на этот раз доступ предоставляется (`trust`) без аутентификации.
4. Наконец, последняя строка отклоняет любое входящее соединение с хоста `e1r1` от пользователя `murat` на БД `digikamdb`;

## Группы в pg_hba.conf

В `pg_hba.conf`, чтобы разрешить вход пользователям группы, нужно добавить знак `+` перед названием роли.

В примере ниже разрешается подключаться к БД `deadline` участникам группы `testers`.

```
host deadline +testers all scram-sha-256
```

### Полезное

- [GRANT](https://www.postgresql.org/docs/current/sql-grant.html)

### Задание

1. На сервере установлен `postgres`. В ней создана база данных `deadline`.
2. Создайте группы: `administrator` и `student`.
3. Создайте пользователей, которые состоят в группе `administrator`:
   - `arman` с паролем `M96pgz3h`.
   - `dias` с паролем `sxr9hN5h`.
4. Создайте пользователей, которые состоят в группе `student`:
   - `artem` с паролем `UD4z3Evu`
   - `lyazzat` с паролем `PG9ku65k`
5. Cоздайте пользователя `askhat` с паролем `9a5fZzzj`, который состоит в обоих группах.
6. Дайте права на все операции на все таблицы в базе данных `deadline` группе `administrator`.
7. Дайте права только на `SELECT` на все таблицы в базе данных `deadline` группе `student`.
8. В `pg_hba.conf` настройте следующие правила:
   - TCP/IP соединение на БД `deadline` группе `administrator` из подсети `127.0.0.1/24`
     с аутентификацией через `md5`.
   - TCP/IP соединение на БД `deadline` группе `student` из подсети `127.0.0.1/24`
     с аутентификацией через `scram-sha-256`.
   - Запрет на TCP/IP соединение пользователю `askhat` из всех хостов на все БД.
   - TCP/IP соединение на все БД пользователю `postgres` из всех хостов
     с аутентификацией `md5`.

---

### Ответ

